<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>แฟลชการ์ดเต็มจอ</title>
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      font-family: 'Kanit', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, 
        #667eea 0%, 
        #764ba2 25%, 
        #f093fb 50%, 
        #f5576c 75%, 
        #4facfe 100%);
      background-size: 300% 300%;
      animation: gradientShift 8s ease infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Floating particles effect */
    .particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      animation: float 6s infinite ease-in-out;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 1; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
    }

    /* Grammar Panel CSS */
    .grammar-panel {
      position: fixed;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 360px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      z-index: 10;
      max-height: 85vh;
      overflow-y: auto;
    }

    .grammar-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 15px;
      text-align: center;
    }

    .grammar-textarea {
      width: 100%;
      height: 120px;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 0.95rem;
      font-family: 'Kanit', sans-serif;
      resize: vertical;
      margin-bottom: 15px;
      transition: border-color 0.3s;
      background: rgba(255, 255, 255, 0.9);
    }

    .grammar-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .grammar-controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 15px;
    }

    .language-select {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 0.95rem;
      font-family: 'Kanit', sans-serif;
      background: rgba(255, 255, 255, 0.9);
      transition: border-color 0.3s;
    }

    .language-select:focus {
      outline: none;
      border-color: #667eea;
    }

    .grammar-check-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Kanit', sans-serif;
    }

    .grammar-check-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .grammar-check-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .grammar-results {
      margin-top: 15px;
      padding: 15px;
      background: rgba(248, 249, 250, 0.9);
      border-radius: 12px;
      border-left: 4px solid #28a745;
      font-size: 0.9rem;
      line-height: 1.6;
      max-height: 350px;
      overflow-y: auto;
    }

    .grammar-results.error {
      border-left-color: #dc3545;
      background: rgba(255, 242, 242, 0.9);
    }

    .grammar-results.warning {
      border-left-color: #ffc107;
      background: rgba(255, 252, 230, 0.9);
    }

    .grammar-results.success {
      border-left-color: #28a745;
      background: rgba(240, 255, 240, 0.9);
    }

    .grammar-error-item {
      margin-bottom: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      border-left: 3px solid #dc3545;
    }

    .grammar-error-type {
      font-weight: 600;
      color: #dc3545;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }

    .grammar-error-message {
      color: #2c3e50;
      margin-top: 4px;
      line-height: 1.5;
    }

    .grammar-context {
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
      font-family: monospace;
      font-size: 0.9rem;
      color: #495057;
    }

    .grammar-error-text {
      background: #ffebee;
      color: #c62828;
      padding: 2px 4px;
      border-radius: 3px;
      font-weight: 500;
    }

    .grammar-suggestion {
      color: #28a745;
      margin-top: 6px;
      padding: 8px;
      background: rgba(40, 167, 69, 0.1);
      border-radius: 6px;
    }

    .grammar-suggestion-item {
      display: inline-block;
      background: #28a745;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      margin: 2px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .grammar-suggestion-item:hover {
      background: #218838;
      transform: translateY(-1px);
    }

    /* Main container adjustment for grammar panel */
    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 2;
      padding: 20px;
      margin-left: 0;
    }
    
    /* Progress bar */
    .progress-container {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 600px;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
      border-radius: 20px;
      transition: width 0.5s ease;
      box-shadow: 0 0 20px rgba(79, 172, 254, 0.5);
    }
    
    /* Card container with flip effect */
    .card-container {
      perspective: 1000px;
      width: 80%;
      max-width: 700px;
      height: 70%;
      max-height: 500px;
      margin-bottom: 40px;
    }
    
    .flashcard {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer;
    }
    
    .flashcard.flipped {
      transform: rotateY(180deg);
    }
    
    .card-front, .card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.15),
        0 0 60px rgba(255, 255, 255, 0.1) inset;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .card-front {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.9) 0%, 
        rgba(255, 255, 255, 0.7) 100%);
      color: #2c3e50;
    }
    
    .card-back {
      background: linear-gradient(135deg, 
        rgba(52, 152, 219, 0.9) 0%, 
        rgba(155, 89, 182, 0.8) 100%);
      color: white;
      transform: rotateY(180deg);
    }
    
    .card-content {
      font-size: clamp(1.8rem, 4vw, 3.5rem);
      font-weight: 500;
      line-height: 1.4;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: textGlow 2s ease-in-out infinite alternate;
    }
    
    @keyframes textGlow {
      from { text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
      to { text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 0 20px rgba(255, 255, 255, 0.3); }
    }
    
    /* Controls */
    .controls {
      display: flex;
      gap: 20px;
      align-items: center;
      z-index: 3;
    }
    
    .btn {
      padding: 18px 36px;
      font-size: 1.3rem;
      font-weight: 500;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      font-family: 'Kanit', sans-serif;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    
    .btn-primary:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      box-shadow: 0 10px 30px rgba(240, 147, 251, 0.4);
    }
    
    .btn-secondary:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 15px 40px rgba(240, 147, 251, 0.6);
    }
    
    /* Card counter */
    .card-counter {
      position: absolute;
      top: 50%;
      right: 30px;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 15px 25px;
      border-radius: 25px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #2c3e50;
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    }
    
    /* Instructions */
    .instructions {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.8);
      font-size: 1rem;
      text-align: center;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .grammar-panel {
        display: none;
      }
      
      .card-container {
        width: 95%;
        height: 60%;
      }
      
      .card-front, .card-back {
        padding: 25px;
      }
      
      .btn {
        padding: 15px 30px;
        font-size: 1.1rem;
      }
      
      .card-counter {
        right: 20px;
        padding: 12px 20px;
        font-size: 1rem;
      }
      
      .progress-container {
        width: 90%;
        top: 20px;
      }
    }

    @media (max-width: 1200px) {
      .grammar-panel {
        width: 320px;
        left: 15px;
      }
    }
    
    /* Loading animation */
    .loading {
      font-size: 2rem;
      color: white;
      animation: loadingPulse 1.5s ease-in-out infinite;
    }
    
    @keyframes loadingPulse {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }

    /* Home navigation */
    .home-navigation {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
    }
    
    .home-btn {
      padding: 10px 20px;
      font-size: 1rem;
      font-weight: 500;
      color: #2c3e50;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      text-decoration: none;
      display: inline-block;
    }
    
    .home-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    /* Quick fix buttons */
    .quick-fixes {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      padding: 10px;
      background: rgba(240, 247, 255, 0.8);
      border-radius: 8px;
    }

    .quick-fix-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-family: 'Kanit', sans-serif;
      transition: all 0.2s;
    }

    .quick-fix-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }

    .test-btn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52) !important;
    }
  </style>
</head>
<body>
  <!-- Grammar Check Panel -->
  <div class="grammar-panel">
    <h3 class="grammar-title">Grammar Checker 📝</h3>
    <textarea 
      id="grammarTextarea" 
      class="grammar-textarea" 
      placeholder="Write a sentence using the current word..."
    ></textarea>
    <div class="grammar-controls">
      <select id="languageSelect" class="language-select">
        <option value="en-US">American English</option>
        <option value="en-GB">British English</option>
      </select>
      <button type="button" class="grammar-check-btn" onclick="performGrammarCheck()">Check Grammar</button>
    </div>
    <div id="grammarResults" class="grammar-results" style="display: none;"></div>
    
    <!-- Quick fixes section -->
    <div id="quickFixes" class="quick-fixes">
      <button type="button" class="quick-fix-btn" onclick="insertTestSentence()">🧪 Test</button>
      <button type="button" class="quick-fix-btn" onclick="fixCommonError('don\\'t', 'doesn\\'t')">Fix don't→doesn't</button>
      <button type="button" class="quick-fix-btn" onclick="fixCommonError('has', 'have')">Fix has→have</button>
    </div>
  </div>

  <!-- Floating particles -->
  <div class="particles" id="particles"></div>
  
  <!-- Progress bar -->
  <div class="progress-container">
    <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
  </div>
  
  <!-- Card counter -->
  <div class="card-counter" id="cardCounter">
    Loading...
  </div>
  
  <div class="container">
    <!-- Flashcard -->
    <div class="card-container">
      <div class="flashcard" id="flashcard" onclick="flipCard()">
        <div class="card-front">
          <div class="card-content" id="frontContent">
            <div class="loading">กำลังโหลด...</div>
          </div>
        </div>
        <div class="card-back">
          <div class="card-content" id="backContent">
            คำแปล
          </div>
        </div>
      </div>
    </div>

    <!-- Listen button above input field -->
    <div style="margin-bottom: 10px; text-align: center;">
      <button id="listenBtn" class="btn btn-primary" style="margin-bottom: 8px; padding: 10px 24px; font-size: 1.1rem;" onclick="speakCurrentWord()">🔊 Listen</button>
    </div>
    
    <!-- Skip to word input -->
    <div style="margin-bottom: 20px; text-align: center;">
      <input type="text" id="skipWordInput" placeholder="พิมพ์คำศัพท์เพื่อข้ามไป..." style="padding: 10px 18px; border-radius: 25px; border: 1px solid #ccc; font-size: 1.1rem; width: 220px;" onkeypress="handleEnterKey(event)">
      <button class="btn btn-primary" style="margin-left: 10px; padding: 10px 24px; font-size: 1.1rem;" onclick="skipToWord()">ข้ามไปคำนั้น</button>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="btn btn-secondary" onclick="previousCard()">Previous</button>
      <button class="btn btn-primary" onclick="nextCard()">Next</button>
    </div>
  </div>
  
  <!-- Footer Instructions -->
  <footer style="position: fixed; left: 0; bottom: 0; width: 100%; background: none; z-index: 10;">
    <div style="text-align: left; padding: 12px 24px; color: rgba(255,255,255,0.85); font-size: 0.85rem; font-family: 'Kanit', sans-serif;">
        คลิกที่การ์ดเพื่อดูคำแปล • กด Space เพื่อพลิกการ์ด • ใช้ลูกศรซ้าย/ขวาเพื่อนำทาง
    </div>
  </footer>

  <!-- Home navigation -->
  <div class="home-navigation">
    <a href="index.html" class="home-btn">Home</a>
  </div>

  <script>
    // Global variables
    let flashcards = [];
    let currentIndex = 0;
    let isFlipped = false;

    // Initialize the application
    function initializeApp() {
      console.log('Initializing application...');
      createParticles();
      loadFlashcardsData();
      setupKeyboardShortcuts();
    }

    // Create floating particles effect
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    // Load flashcards data from JSON files
    async function loadFlashcardsData() {
      const jsonFiles = [
        'longman_flashcards_1_500.json',
        'longman_flashcards_501_1000.json',
        'longman_flashcards_1001_1500.json',
        'longman_flashcards_1501_2000.json',
        'longman_flashcards_2001_2500.json',
        'longman_flashcards_2501_3000.json',
        'longman_flashcards_3001_3135.json'
      ];

      try {
        console.log('Loading flashcard data from JSON files...');
        let allCards = [];
        
        for (const fileName of jsonFiles) {
          try {
            const response = await fetch(fileName);
            if (response.ok) {
              const data = await response.json();
              allCards = allCards.concat(data);
              console.log(`Loaded ${data.length} cards from ${fileName}`);
            } else {
              console.warn(`Could not load ${fileName}: ${response.status}`);
            }
          } catch (fileError) {
            console.warn(`Error loading ${fileName}:`, fileError);
          }
        }

        if (allCards.length > 0) {
          flashcards = allCards;
          console.log(`Successfully loaded ${flashcards.length} total flashcards`);
          
          // Initialize the first card
          updateCurrentCard();
          updateProgress();
          updateCounter();
        } else {
          // Show error if no files found
          console.error('No JSON files found or loaded successfully');
          document.getElementById('frontContent').innerHTML = '<div style="color: red; font-size: 1.5rem;">ไม่พบไฟล์ JSON<br>กรุณาวางไฟล์ในโฟลเดอร์เดียวกัน</div>';
          document.getElementById('cardCounter').textContent = 'Error: No data';
        }

      } catch (error) {
        console.error('Error in loadFlashcardsData:', error);
        document.getElementById('frontContent').innerHTML = '<div style="color: red; font-size: 1.5rem;">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>';
        document.getElementById('cardCounter').textContent = 'Error';
      }
    }

    // Update the current flashcard display
    function updateCurrentCard() {
      if (flashcards.length === 0) return;

      const frontContent = document.getElementById('frontContent');
      const backContent = document.getElementById('backContent');
      const flashcard = document.getElementById('flashcard');
      
      // Reset flip state
      isFlipped = false;
      flashcard.classList.remove('flipped');
      
      // Update content
      const currentCard = flashcards[currentIndex];
      frontContent.innerHTML = `<h2 style="margin-bottom: 16px; font-size: 2.2rem; font-weight: 600;">${currentCard.word || 'No word'}</h2>`;
      backContent.textContent = currentCard.definition || 'No definition';
    }

    // Navigation functions
    function nextCard() {
      if (flashcards.length === 0) return;
      currentIndex = (currentIndex + 1) % flashcards.length;
      updateCurrentCard();
      updateProgress();
      updateCounter();
    }

    function previousCard() {
      if (flashcards.length === 0) return;
      currentIndex = (currentIndex - 1 + flashcards.length) % flashcards.length;
      updateCurrentCard();
      updateProgress();
      updateCounter();
    }

    function flipCard() {
      const flashcard = document.getElementById('flashcard');
      isFlipped = !isFlipped;
      if (isFlipped) {
        flashcard.classList.add('flipped');
      } else {
        flashcard.classList.remove('flipped');
      }
    }

    // Update progress bar
    function updateProgress() {
      if (flashcards.length === 0) return;
      const progressBar = document.getElementById('progressBar');
      const progress = ((currentIndex + 1) / flashcards.length) * 100;
      progressBar.style.width = progress + '%';
    }

    // Update card counter
    function updateCounter() {
      const counter = document.getElementById('cardCounter');
      if (flashcards.length === 0) {
        counter.textContent = 'Loading...';
      } else {
        counter.textContent = `${currentIndex + 1} / ${flashcards.length}`;
      }
    }

    // Text-to-speech function
    function speakCurrentWord() {
      if (flashcards.length === 0) return;
      const currentWord = flashcards[currentIndex].word;
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(currentWord);
        utterance.lang = 'en-US';
        utterance.rate = 0.8;
        speechSynthesis.speak(utterance);
      } else {
        alert('Speech synthesis not supported in this browser');
      }
    }

    // Skip to specific word
    function skipToWord() {
      const input = document.getElementById('skipWordInput');
      const searchTerm = input.value.trim().toLowerCase();
      
      if (!searchTerm || flashcards.length === 0) return;
      
      const foundIndex = flashcards.findIndex(card => 
        card.word.toLowerCase().includes(searchTerm)
      );
      
      if (foundIndex !== -1) {
        currentIndex = foundIndex;
        updateCurrentCard();
        updateProgress();
        updateCounter();
        input.value = '';
      } else {
        alert('ไม่พบคำศัพท์ที่ค้นหา');
      }
    }

    // Handle Enter key for skip input
    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        skipToWord();
      }
    }

    // Setup keyboard shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(event) {
        // Don't trigger shortcuts when typing in input fields
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
          return;
        }

        switch(event.code) {
          case 'Space':
            event.preventDefault();
            flipCard();
            break;
          case 'ArrowRight':
            nextCard();
            break;
          case 'ArrowLeft':
            previousCard();
            break;
        }
      });
    }

    // Grammar Checker Functions
    async function performGrammarCheck() {
      const textarea = document.getElementById('grammarTextarea');
      const resultsDiv = document.getElementById('grammarResults');
      const checkBtn = document.querySelector('.grammar-check-btn');
      const languageSelect = document.getElementById('languageSelect');
      
      const text = textarea.value.trim();
      
      if (!text) {
        showGrammarResults('⚠️ โปรดใส่ประโยคที่ต้องการตรวจสอบ', 'warning');
        return;
      }
      
      // Disable button and show loading
      checkBtn.disabled = true;
      checkBtn.textContent = 'กำลังตรวจสอบ...';
      
      try {
        console.log('Checking grammar for:', text);
        
        // Try LanguageTool API first
        const response = await fetch('https://api.languagetool.org/v2/check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            'text': text,
            'language': languageSelect.value || 'en-US'
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('LanguageTool response:', data);
          
          if (data.matches && data.matches.length > 0) {
            displayGrammarErrors(data.matches, text);
          } else {
            showGrammarResults('✅ ไม่พบข้อผิดพลาดทางไวยากรณ์!', 'success');
          }
        } else {
          throw new Error('API request failed');
        }
        
      } catch (error) {
        console.log('API failed, using local grammar check:', error);
        // Fallback to local grammar checking
        const localErrors = checkLocalGrammar(text);
        if (localErrors.length > 0) {
          displayLocalErrors(localErrors, text);
        } else {
          showGrammarResults('✅ ไม่พบข้อผิดพลาดทางไวยากรณ์! (ตรวจสอบแบบออฟไลน์)', 'success');
        }
      }
      
      // Re-enable button
      checkBtn.disabled = false;
      checkBtn.textContent = 'Check Grammar';
    }

    function displayGrammarErrors(matches, originalText) {
      let html = `<strong>🔍 พบข้อผิดพลาด ${matches.length} จุด:</strong><br><br>`;
      
      matches.forEach((match, index) => {
        const errorText = originalText.substring(match.offset, match.offset + match.length);
        const beforeText = originalText.substring(Math.max(0, match.offset - 15), match.offset);
        const afterText = originalText.substring(match.offset + match.length, Math.min(originalText.length, match.offset + match.length + 15));
        
        html += `
          <div class="grammar-error-item">
            <div class="grammar-error-type">${match.rule.category.name || 'Grammar Error'}</div>
            <div class="grammar-error-message">${match.message}</div>
            <div class="grammar-context">
              Context: ${beforeText}<span class="grammar-error-text">${errorText}</span>${afterText}
            </div>
        `;
        
        if (match.replacements && match.replacements.length > 0) {
          html += '<div class="grammar-suggestion">💡 Suggestions: ';
          match.replacements.slice(0, 3).forEach(replacement => {
            html += `<span class="grammar-suggestion-item" onclick="applySuggestion('${errorText.replace(/'/g, "\\'")}', '${replacement.value.replace(/'/g, "\\'")}')">${replacement.value}</span> `;
          });
          html += '</div>';
        }
        
        html += '</div>';
      });
      
      showGrammarResults(html, 'error');
    }

    function checkLocalGrammar(text) {
      const errors = [];
      const lowerText = text.toLowerCase();
      
      // Common grammar patterns
      const grammarRules = [
        { pattern: /\b(he|she|it)\s+don't\b/gi, correction: "doesn't", message: "Subject-verb disagreement" },
        { pattern: /\b(i|you|we|they)\s+doesn't\b/gi, correction: "don't", message: "Subject-verb disagreement" },
        { pattern: /\b(he|she|it)\s+have\b/gi, correction: "has", message: "Subject-verb disagreement" },
        { pattern: /\b(i|you|we|they)\s+has\b/gi, correction: "have", message: "Subject-verb disagreement" },
        { pattern: /\ba\s+(apple|orange|elephant|umbrella|hour)\b/gi, correction: "an", message: "Article error" },
        { pattern: /\ban\s+(car|book|house|dog|cat)\b/gi, correction: "a", message: "Article error" }
      ];
      
      grammarRules.forEach(rule => {
        const matches = text.matchAll(rule.pattern);
        for (const match of matches) {
          errors.push({
            type: rule.message,
            original: match[0],
            suggestion: rule.correction,
            position: match.index,
            context: text.substring(Math.max(0, match.index - 15), match.index + match[0].length + 15)
          });
        }
      });
      
      return errors;
    }

    function displayLocalErrors(errors, originalText) {
      let html = `<strong>🔍 พบข้อผิดพลาด ${errors.length} จุด:</strong><br><br>`;
      
      errors.forEach(error => {
        html += `
          <div class="grammar-error-item">
            <div class="grammar-error-type">${error.type}</div>
            <div class="grammar-error-message">Found: "${error.original}"</div>
            <div class="grammar-context">Context: ${error.context.replace(error.original, `<span class="grammar-error-text">${error.original}</span>`)}</div>
            <div class="grammar-suggestion">
              💡 Suggestion: <span class="grammar-suggestion-item" onclick="applySuggestion('${error.original.replace(/'/g, "\\'")}', '${error.suggestion.replace(/'/g, "\\'")}')">${error.suggestion}</span>
            </div>
          </div>
        `;
      });
      
      showGrammarResults(html, 'error');
    }

    function showGrammarResults(content, type) {
      const resultsDiv = document.getElementById('grammarResults');
      resultsDiv.innerHTML = content;
      resultsDiv.className = `grammar-results ${type}`;
      resultsDiv.style.display = 'block';
    }

    function applySuggestion(original, suggestion) {
      const textarea = document.getElementById('grammarTextarea');
      const text = textarea.value;
      const newText = text.replace(original, suggestion);
      textarea.value = newText;
      
      // Re-check grammar after applying suggestion
      setTimeout(performGrammarCheck, 500);
    }

    // Quick fix functions
    function insertTestSentence() {
      const textarea = document.getElementById('grammarTextarea');
      textarea.value = "He don't like coffee and I has a apple. She are very beautiful.";
      performGrammarCheck();
    }

    function fixCommonError(find, replace) {
      const textarea = document.getElementById('grammarTextarea');
      const text = textarea.value;
      const regex = new RegExp(`\\b${find}\\b`, 'gi');
      textarea.value = text.replace(regex, replace);
      setTimeout(performGrammarCheck, 300);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing app...');
      initializeApp();
    });

    // Make functions globally available for onclick handlers
    window.performGrammarCheck = performGrammarCheck;
    window.insertTestSentence = insertTestSentence;
    window.fixCommonError = fixCommonError;
    window.applySuggestion = applySuggestion;
    window.flipCard = flipCard;
    window.nextCard = nextCard;
    window.previousCard = previousCard;
    window.skipToWord = skipToWord;
    window.handleEnterKey = handleEnterKey;
    window.speakCurrentWord = speakCurrentWord;
  </script>
</body>
</html>
